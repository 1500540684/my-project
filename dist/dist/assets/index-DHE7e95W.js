import{_ as ce,r as b,p as ve,c as f,d as w,F as _,i as P,e as t,f as d,g as F,C as J,D as pe,x as H,E as R,R as me,u as ye,o as m,n as be,t as D,j as g}from"./index-Bqka696Z.js";import{g as K,a as Q}from"./transaction-DUqCAnlx.js";const ge={class:"transaction-container"},fe={class:"section-header"},ke={class:"tabs-list"},_e=["onClick"],he={class:"action-buttons"},Te={class:"table-search-bar"},we={class:"table-section"},Fe={class:"pagination"},Ce={class:"table-search-bar"},xe={class:"table-section"},Ie={class:"pagination"},De={__name:"index",setup(ze){const V=b("detail"),W=ye();function O(s){console.log(s),W.push({name:"GZYTransactionDetail",params:{id:s.transactionId||s.serial}})}const r=b({matrixAccount:"",dateRange:[],cardId:"",cardType:"",cardFormFactor:"",transactionId:"",transactionType:"",status:""}),G=[{key:"createdAt",label:"交易时间",visible:!0},{key:"maskCardNo",label:"卡号",visible:!0},{key:"cardType",label:"卡类型",visible:!0},{key:"transactionType",label:"交易类型",visible:!0},{key:"transactionAmount",label:"交易金额",visible:!0},{key:"feeDeductionAmount",label:"手续费",visible:!0},{key:"status",label:"交易状态",visible:!0}],U=b([]),x=b(1),S=b(10),M=b(0),$=b(!1);async function z(){$.value=!0;try{const s={pageIndex:x.value,pageSize:S.value,matrixAccount:r.value.matrixAccount||void 0,cardId:r.value.cardId||void 0,cardType:r.value.cardType||void 0,cardFormFactor:r.value.cardFormFactor||void 0,transactionId:r.value.transactionId||void 0,transactionType:r.value.transactionType||void 0,status:r.value.status||void 0};r.value.dateRange&&r.value.dateRange.length===2&&(s.createdAtStart=r.value.dateRange[0],s.createdAtEnd=r.value.dateRange[1]);const a=await K(s);a.code===200?(U.value=a.data.data||[],M.value=a.data.total||0):(U.value=[],M.value=0)}finally{$.value=!1}}const u=b({dateRange:[],memberId:"",cardId:"",cardFormFactor:"",status:""}),Z=[{key:"applyTime",label:"申请日期",visible:!0},{key:"cardNumber",label:"卡号",visible:!0},{key:"cardType",label:"卡类型",visible:!0},{key:"nickname",label:"昵称",visible:!0},{key:"type",label:"类型",visible:!0},{key:"receiveType",label:"收款类型",visible:!0},{key:"status",label:"交易状态",visible:!0},{key:"fee",label:"手续费",visible:!0}],L=b([]),I=b(1),Y=b(10),N=b(0),E=b(!1);async function A(){var s,a,y,k,c,h;try{E.value=!0;const n={pageIndex:I.value,pageSize:Y.value,memberId:u.value.memberId||void 0,cardId:u.value.cardId||void 0,cardFormFactor:u.value.cardFormFactor||void 0,status:u.value.status||void 0};u.value.dateRange&&u.value.dateRange.length===2&&(n.createdAtStart=u.value.dateRange[0],n.createdAtEnd=u.value.dateRange[1]);const l=await Q(n);if(l.code===200){const T=Array.isArray((a=(s=l==null?void 0:l.data)==null?void 0:s.data)==null?void 0:a.data)?l.data.data.data:Array.isArray((y=l==null?void 0:l.data)==null?void 0:y.data)?l.data.data:[];L.value=T.map(i=>({applyTime:i.createdAt,cardNumber:i.maskCardNo,cardType:i.cardType,nickname:i.nickname||"",type:i.feeType,receiveType:i.cardScheme,status:i.status,fee:`${i.actualFeeAmount} ${i.actualFeeCurrency}`})),N.value=((c=(k=l==null?void 0:l.data)==null?void 0:k.data)==null?void 0:c.total)||((h=l==null?void 0:l.data)==null?void 0:h.total)||T.length}}catch(n){console.error("获取卡历史记录失败:",n),R.error("获取卡历史记录失败"),L.value=[],N.value=0}finally{E.value=!1}}ve(()=>{z(),A()});const X=s=>{S.value=s,x.value=1,z()},ee=s=>{x.value=s,z()},ae=s=>{Y.value=s,I.value=1,A()},te=s=>{I.value=s,A()},le=[{key:"detail",label:"交易详情"},{key:"history",label:"卡历史"}],ne=s=>{V.value=s};async function re(s){var k,c,h;const a=s==="detail",y=me.service({lock:!0,text:`正在下载${a?"交易详情":"卡历史"}数据...`,background:"rgba(0, 0, 0, 0.7)"});try{const n={pageIndex:1,pageSize:50};if(a){Object.assign(n,{matrixAccount:r.value.matrixAccount||void 0,cardId:r.value.cardId||void 0,cardType:r.value.cardType||void 0,cardFormFactor:r.value.cardFormFactor||void 0,transactionId:r.value.transactionId||void 0,transactionType:r.value.transactionType||void 0,status:r.value.status||void 0}),r.value.dateRange&&r.value.dateRange.length===2&&(n.createdAtStart=r.value.dateRange[0],n.createdAtEnd=r.value.dateRange[1]);const l=await K(n);if(l.code===200){const T=l.data.data||[];q(T,G,"交易详情.csv")}else R.error("下载交易详情失败")}else{Object.assign(n,{memberId:u.value.memberId||void 0,cardId:u.value.cardId||void 0,cardFormFactor:u.value.cardFormFactor||void 0,status:u.value.status||void 0}),u.value.dateRange&&u.value.dateRange.length===2&&(n.createdAtStart=u.value.dateRange[0],n.createdAtEnd=u.value.dateRange[1]);const l=await Q(n);if(l.code===200){const i=(Array.isArray((c=(k=l==null?void 0:l.data)==null?void 0:k.data)==null?void 0:c.data)?l.data.data.data:Array.isArray((h=l==null?void 0:l.data)==null?void 0:h.data)?l.data.data:[]).map(v=>({applyTime:v.createdAt,cardNumber:v.maskCardNo,cardType:v.cardType,nickname:v.nickname||"",type:v.feeType,receiveType:v.cardScheme,status:v.status,fee:`${v.actualFeeAmount} ${v.actualFeeCurrency}`}));q(i,Z,"卡历史.csv")}else R.error("下载卡历史失败")}}catch(n){console.error("下载数据失败:",n),R.error("下载数据失败，请稍后重试")}finally{y.close()}}function q(s,a,y){const k=a.filter(v=>v.visible),c=k.map(v=>v.label).join(","),h=s.map(v=>k.map(C=>{let p=v[C.key];return C.key==="status"?p=j(p):C.key==="transactionType"||C.key==="type"?p=B(p):(C.key==="createdAt"||C.key==="applyTime")&&(p=p?new Date(p).toLocaleString():""),typeof p=="string"&&(p.includes(",")||p.includes('"')||p.includes(`
`))?`"${p.replace(/"/g,'""')}"`:p??""}).join(",")),l="\uFEFF"+[c,...h].join(`
`),T=new Blob([l],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");i.href=URL.createObjectURL(T),i.setAttribute("download",`${y}_${new Date().toLocaleString().replace(/[\/\s:]/g,"_")}`),document.body.appendChild(i),i.click(),document.body.removeChild(i),R.success(`${y} 下载成功`)}const se=()=>{x.value=1,z()},oe=()=>{r.value={matrixAccount:"",dateRange:[],cardId:"",cardType:"",cardFormFactor:"",transactionId:"",transactionType:"",status:""},x.value=1,z()},de=()=>{I.value=1,A()},ue=()=>{u.value={dateRange:[],memberId:"",cardId:"",cardFormFactor:"",status:""},I.value=1,A()},j=s=>({pending:"处理中",succeed:"成功",failed:"失败"})[s]||s,ie={recharge:"充值",discard_recharge_return:"销卡退款",recharge_return:"退款"},B=s=>ie[s]||s;return(s,a)=>{const y=F("el-button"),k=F("el-date-picker"),c=F("el-form-item"),h=F("el-input"),n=F("el-option"),l=F("el-select"),T=F("el-form"),i=F("el-table-column"),v=F("el-table"),C=F("el-pagination"),p=pe("loading");return m(),f("div",ge,[w("div",fe,[w("div",ke,[(m(),f(_,null,P(le,e=>w("div",{key:e.key,class:be(["tab-item",{active:V.value===e.key}]),onClick:o=>ne(e.key)},D(e.label),11,_e)),64))]),w("div",he,[t(y,{type:"primary",plain:"",onClick:a[0]||(a[0]=e=>re(V.value))},{default:d(()=>a[13]||(a[13]=[g("下载")])),_:1})])]),V.value==="detail"?(m(),f(_,{key:0},[w("div",Te,[t(T,{inline:!0,class:"search-form-container"},{default:d(()=>[t(c,{label:"时间范围"},{default:d(()=>[t(k,{modelValue:r.value.dateRange,"onUpdate:modelValue":a[1]||(a[1]=e=>r.value.dateRange=e),type:"datetimerange","start-placeholder":"开始日期","end-placeholder":"结束日期",size:"small",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DDTHH:mm:ss",shortcuts:[{text:"最近一周",value:()=>{const e=new Date,o=new Date;return o.setTime(o.getTime()-3600*1e3*24*7),[o,e]}},{text:"最近一个月",value:()=>{const e=new Date,o=new Date;return o.setTime(o.getTime()-3600*1e3*24*30),[o,e]}},{text:"最近三个月",value:()=>{const e=new Date,o=new Date;return o.setTime(o.getTime()-3600*1e3*24*90),[o,e]}}],style:{width:"360px"}},null,8,["modelValue","shortcuts"])]),_:1}),t(c,null,{default:d(()=>[t(h,{modelValue:r.value.transactionId,"onUpdate:modelValue":a[2]||(a[2]=e=>r.value.transactionId=e),placeholder:"交易ID",size:"small",clearable:"",style:{width:"140px"}},null,8,["modelValue"])]),_:1}),t(c,null,{default:d(()=>[t(l,{modelValue:r.value.transactionType,"onUpdate:modelValue":a[3]||(a[3]=e=>r.value.transactionType=e),placeholder:"交易类型",size:"small",style:{width:"120px"},clearable:""},{default:d(()=>[t(n,{label:"全部",value:""}),t(n,{label:"充值",value:"recharge"}),t(n,{label:"销卡退款",value:"discard_recharge_return"}),t(n,{label:"退款",value:"recharge_return"})]),_:1},8,["modelValue"])]),_:1}),t(c,null,{default:d(()=>[t(l,{modelValue:r.value.status,"onUpdate:modelValue":a[4]||(a[4]=e=>r.value.status=e),placeholder:"交易状态",size:"small",style:{width:"120px"},clearable:""},{default:d(()=>[t(n,{label:"全部",value:""}),t(n,{label:"处理中",value:"pending"}),t(n,{label:"成功",value:"succeed"}),t(n,{label:"失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),t(c,{class:"search-icon-btns",style:{display:"flex","align-items":"center"}},{default:d(()=>[t(y,{type:"primary",size:"small",onClick:se},{default:d(()=>a[14]||(a[14]=[g("搜索")])),_:1}),t(y,{size:"small",onClick:oe},{default:d(()=>a[15]||(a[15]=[g("重置")])),_:1})]),_:1})]),_:1})]),w("div",we,[J((m(),H(v,{data:U.value,style:{width:"100%"},"table-layout":"auto"},{default:d(()=>[(m(!0),f(_,null,P(G.filter(e=>e.visible),e=>(m(),H(i,{key:e.key,prop:e.key,label:e.label,"min-width":e.key==="maskCardNo"?120:100,"max-width":180},{default:d(o=>[e.key==="status"?(m(),f(_,{key:0},[g(D(j(o.row.status)),1)],64)):e.key==="transactionType"?(m(),f(_,{key:1},[g(D(B(o.row.transactionType)),1)],64)):(m(),f(_,{key:2},[g(D(o.row[e.key]),1)],64))]),_:2},1032,["prop","label","min-width"]))),128)),t(i,{label:"操作",width:"80"},{default:d(e=>[t(y,{type:"primary",link:"",class:"detail-btn",onClick:o=>O(e.row)},{default:d(()=>a[16]||(a[16]=[g("详情")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[p,$.value]]),w("div",Fe,[t(C,{background:"",layout:"total, sizes, prev, pager, next, jumper",total:M.value,"page-sizes":[10,20,50],"current-page":x.value,"onUpdate:currentPage":a[5]||(a[5]=e=>x.value=e),"page-size":S.value,"onUpdate:pageSize":a[6]||(a[6]=e=>S.value=e),onSizeChange:X,onCurrentChange:ee},null,8,["total","current-page","page-size"])])])],64)):(m(),f(_,{key:1},[w("div",Ce,[t(T,{inline:!0,class:"search-form-container"},{default:d(()=>[t(c,{label:"时间范围"},{default:d(()=>[t(k,{modelValue:u.value.dateRange,"onUpdate:modelValue":a[7]||(a[7]=e=>u.value.dateRange=e),type:"datetimerange","start-placeholder":"开始日期","end-placeholder":"结束日期",size:"small",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DDTHH:mm:ss",shortcuts:[{text:"最近一周",value:()=>{const e=new Date,o=new Date;return o.setTime(o.getTime()-3600*1e3*24*7),[o,e]}},{text:"最近一个月",value:()=>{const e=new Date,o=new Date;return o.setTime(o.getTime()-3600*1e3*24*30),[o,e]}}],style:{width:"360px"}},null,8,["modelValue","shortcuts"])]),_:1}),t(c,null,{default:d(()=>[t(h,{modelValue:u.value.cardId,"onUpdate:modelValue":a[8]||(a[8]=e=>u.value.cardId=e),placeholder:"卡ID",size:"small",clearable:"",style:{width:"140px"}},null,8,["modelValue"])]),_:1}),t(c,null,{default:d(()=>[t(l,{modelValue:u.value.cardFormFactor,"onUpdate:modelValue":a[9]||(a[9]=e=>u.value.cardFormFactor=e),placeholder:"卡介质",size:"small",style:{width:"120px"},clearable:""},{default:d(()=>[t(n,{label:"全部",value:""}),t(n,{label:"虚拟卡",value:"virtual_card"}),t(n,{label:"实体卡",value:"physical_card"})]),_:1},8,["modelValue"])]),_:1}),t(c,null,{default:d(()=>[t(l,{modelValue:u.value.status,"onUpdate:modelValue":a[10]||(a[10]=e=>u.value.status=e),placeholder:"交易状态",size:"small",style:{width:"120px"},clearable:""},{default:d(()=>[t(n,{label:"全部",value:""}),t(n,{label:"处理中",value:"pending"}),t(n,{label:"成功",value:"succeed"}),t(n,{label:"失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),t(c,{class:"search-icon-btns",style:{display:"flex","align-items":"center"}},{default:d(()=>[t(y,{type:"primary",size:"small",onClick:de},{default:d(()=>a[17]||(a[17]=[g("搜索")])),_:1}),t(y,{size:"small",onClick:ue},{default:d(()=>a[18]||(a[18]=[g("重置")])),_:1})]),_:1})]),_:1})]),w("div",xe,[J((m(),H(v,{data:L.value,style:{width:"100%"},"table-layout":"auto"},{default:d(()=>[(m(!0),f(_,null,P(Z.filter(e=>e.visible),e=>(m(),H(i,{key:e.key,prop:e.key,label:e.label,"min-width":e.key==="cardNumber"?120:100,"max-width":180},{default:d(o=>[e.key==="status"?(m(),f(_,{key:0},[g(D(j(o.row.status)),1)],64)):e.key==="type"?(m(),f(_,{key:1},[g(D(B(o.row.type)),1)],64)):(m(),f(_,{key:2},[g(D(o.row[e.key]),1)],64))]),_:2},1032,["prop","label","min-width"]))),128)),t(i,{label:"操作",width:"80"},{default:d(e=>[t(y,{type:"primary",link:"",class:"detail-btn",onClick:o=>O(e.row)},{default:d(()=>a[19]||(a[19]=[g("详情")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[p,E.value]]),w("div",Ie,[t(C,{background:"",layout:"total, sizes, prev, pager, next, jumper",total:N.value,"page-sizes":[10,20,50],"current-page":I.value,"onUpdate:currentPage":a[11]||(a[11]=e=>I.value=e),"page-size":Y.value,"onUpdate:pageSize":a[12]||(a[12]=e=>Y.value=e),onSizeChange:ae,onCurrentChange:te},null,8,["total","current-page","page-size"])])])],64))])}}},Ve=ce(De,[["__scopeId","data-v-348e7dca"]]);export{Ve as default};
